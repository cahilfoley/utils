cache: npm
language: node_js
node_js:
  - '12'
  - '10'
  - '8'

before_script:
  - curl -L https://codeclimate.com/downloads/test-reporter/test-reporter-latest-linux-amd64 ./cc-test-reporter
  - chmod +x ./cc-test-reporter
  - './cc-test-reporter before-build'
script:
  - echo "Running tests against node $(node -v)"
  - tsc --noEmit
  - jest
after_script:
  - cat .temp/coverage/lcov.info | coveralls
  - './cc-test-reporter format-coverage -t lcov -o .temp/coverage/codeclimate.json .temp/coverage/lcov.info'
  - if [[ "$TRAVIS_TEST_RESULT" == 0 ]]; then ./cc-test-reporter upload-coverage --input .temp/coverage/codeclimate.json; fi

jobs:
  include:
    - stage: deploy
      name: build
      script: npm run build

    - name: publish
      script: echo "Deploying package to npm"
      node_js: 12
      deploy:
        provider: npm
        email: cahil.npm@gmail.com
        api_key: $NPM_API_KEY
        skip_cleanup: true
        on:
          tags: true
          repo: cahilfoley/utils
